<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EMA-ATR 交易策略分析</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: repeating-linear-gradient(90deg, #7b5e57 0px, #7b5e57 80px, #6d4c41 80px, #6d4c41 160px);
            min-height: 100vh;
            padding: 16px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 1.6em;
            margin-bottom: 4px;
            font-weight: 700;
        }
        
        .header p {
            font-size: 0.9em;
            opacity: 0.85;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            padding: 16px;
            background: rgba(248, 249, 250, 0.9);
        }
        
        .stat-card {
            background: white;
            padding: 14px;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
            text-align: center;
            transition: transform 0.2s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-value {
            font-size: 1.6em;
            font-weight: 700;
            margin-bottom: 4px;
        }
        
        .stat-label {
            color: #555;
            font-size: 0.86em;
            letter-spacing: 0.5px;
        }

        .stat-sub {
            margin-top: 4px;
            font-size: 0.78em;
            color: #777;
        }
        
        .positive { color: #28a745; }
        .negative { color: #dc3545; }
        .neutral { color: #6c757d; }
        
        .charts-section {
            padding: 30px;
        }
        
        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }
        
        .chart-title {
            font-size: 1.4em;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
        }
        
        .year-selector {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .year-buttons {
            display: inline-flex;
            background: #f8f9fa;
            border-radius: 25px;
            padding: 5px;
            gap: 5px;
        }
        
        .year-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 20px;
            background: transparent;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .year-btn.active {
            background: #667eea;
            color: white;
        }
        
        .year-btn:hover:not(.active) {
            background: #e9ecef;
        }
        
        .trades-table {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }
        
        .table-header {
            background: #667eea;
            color: white;
            padding: 20px;
            font-size: 1.2em;
            font-weight: 600;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.2em;
            color: #666;
        }
        
        .error {
            text-align: center;
            padding: 50px;
            color: #dc3545;
            font-size: 1.1em;
        }
        
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .year-buttons {
                flex-wrap: wrap;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>EMA-ATR 交易策略分析</h1>
            <p>基于Pine策略的交易数据可视化分析</p>
        </div>
        
        <div id="loading" class="loading">正在加载数据...</div>
        <div id="error" class="error" style="display: none;"></div>

        <div id="content" style="display: none;">
            <div class="stats-grid" id="statsGrid"></div>

            <div class="charts-section">
                <div class="year-selector" style="margin-bottom: 20px;">
                    <div class="year-buttons" id="coinButtons" style="margin-bottom: 12px;"></div>
                    <div class="year-buttons" id="yearButtons"></div>
                </div>

                <div class="chart-container">
                    <div class="chart-title">交易记录柱状图</div>
                    <canvas id="tradesBarChart"></canvas>
                </div>

                <div class="chart-container">
                    <div class="chart-title">三币复利柱状折线图</div>
                    <canvas id="compoundSummaryChart"></canvas>
                </div>

                <div class="chart-container">
                    <div class="chart-title">BTC 历史复利柱状折线图</div>
                    <canvas id="compoundHistoryBTC"></canvas>
                </div>
                <div class="chart-container">
                    <div class="chart-title">ETH 历史复利柱状折线图</div>
                    <canvas id="compoundHistoryETH"></canvas>
                </div>
                <div class="chart-container">
                    <div class="chart-title">SOL 历史复利柱状折线图</div>
                    <canvas id="compoundHistorySOL"></canvas>
                </div>
            </div>

            <div class="trades-table">
                <div class="table-header">
                    <span id="currentYear">2024</span>年交易记录
                </div>
                <div style="overflow-x: auto;">
                    <table id="tradesTable">
                        <thead>
                            <tr>
                                <th>交易编号</th>
                                <th>类型</th>
                                <th>开仓时间</th>
                                <th>开仓价格</th>
                                <th>平仓时间</th>
                                <th>平仓价格</th>
                                <th>盈亏 (USDT)</th>
                                <th>盈亏 (%)</th>
                            </tr>
                        </thead>
                        <tbody id="tradesTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        class TradingDataAnalyzer {
            constructor() {
                this.data = null;
                this.currentYear = null;
                this.currentCoin = null;
                this.coinList = [];
                this.charts = {};
                this.init();
            }
            
            async init() {
                try {
                    await this.loadCoinList();
                    this.currentCoin = this.coinList.includes('btc') ? 'btc' : (this.coinList[0] || 'btc');
                    await this.loadDataForCoin(this.currentCoin);
                    this.renderStats();
                    this.renderCoinButtons();
                    this.renderYearButtons();
                    this.renderTradesBarChart();
                    await this.renderCompoundSummaryChart();
                    await this.renderCompoundHistoryCharts();
                    this.renderTradesTable();
                    this.showContent();
                } catch (error) {
                    this.showError(error.message);
                }
            }

            async loadCoinList() {
                const res = await fetch('/api/coins');
                const json = await res.json();
                this.coinList = json.coins || [];
            }
            
            async loadDataForCoin(coin) {
                try {
                    const response = await fetch(`converted-data/${coin}-trades.json`);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    this.data = await response.json();
                    this.currentYear = this.data.summary.years[this.data.summary.years.length - 1];
                } catch (error) {
                    throw new Error('无法加载交易数据，请确保数据文件存在且格式正确');
                }
            }
            
            renderStats() {
                const stats = this.data.summary.overallStats;
                const totalWins = (stats.longWins || 0) + (stats.shortWins || 0);
                const winRate = stats.totalTrades > 0 ? parseFloat(((totalWins / stats.totalTrades) * 100).toFixed(2)) : 0;
                const y = this.currentYear;
                const ys = this.data.yearlyData[y]?.stats || { totalTrades: 0, longWins: 0, shortWins: 0, totalPnl: 0 };
                const yWins = (ys.longWins || 0) + (ys.shortWins || 0);
                const yWinRate = ys.totalTrades > 0 ? parseFloat(((yWins / ys.totalTrades) * 100).toFixed(2)) : 0;
                const statsGrid = document.getElementById('statsGrid');
                
                const statCards = [
                    { label: '总交易数', value: stats.totalTrades, class: 'neutral' },
                    { label: '总盈亏', value: `¥${stats.totalPnl.toLocaleString()}`, class: stats.totalPnl >= 0 ? 'positive' : 'negative' },
                    { label: '总胜率', value: `${winRate}%`, class: winRate >= 50 ? 'positive' : 'negative' },
                    { label: '该年交易数', value: ys.totalTrades, class: 'neutral' },
                    { label: '该年盈亏', value: `¥${(ys.totalPnl || 0).toLocaleString()}`, class: (ys.totalPnl || 0) >= 0 ? 'positive' : 'negative' },
                    { label: '该年胜率', value: `${yWinRate}%`, class: yWinRate >= 50 ? 'positive' : 'negative' }
                ];
                
                statsGrid.innerHTML = statCards.map(card => `
                    <div class="stat-card">
                        <div class="stat-value ${card.class}">${card.value}</div>
                        <div class="stat-label">${card.label}</div>
                    </div>
                `).join('');
            }

            renderCoinButtons() {
                const coinButtons = document.getElementById('coinButtons');
                const coins = this.coinList.length ? this.coinList : ['btc','eth'];
                coinButtons.innerHTML = coins.map(c => `
                    <button class="year-btn ${c === this.currentCoin ? 'active' : ''}"
                            onclick="analyzer.selectCoin('${c.toLowerCase()}')">
                        ${c.toUpperCase()}
                    </button>
                `).join('');
            }
            
            renderYearButtons() {
                const yearButtons = document.getElementById('yearButtons');
                const years = this.data.summary.years;
                
                yearButtons.innerHTML = years.map(year => `
                    <button class="year-btn ${year === this.currentYear ? 'active' : ''}" 
                            onclick="analyzer.selectYear('${year}')">
                        ${year}
                    </button>
                `).join('');
            }
            
            selectCoin(coin) {
                this.currentCoin = coin;
                this.loadDataForCoin(coin).then(() => {
                    this.renderStats();
                    this.renderCoinButtons();
                    this.renderYearButtons();
                    this.renderTradesBarChart(true);
                    this.renderCompoundSummaryChart(true);
                    this.renderCompoundHistoryCharts(true);
                    this.renderTradesTable();
                    document.getElementById('currentYear').textContent = this.currentYear;
                }).catch(err => this.showError(err.message));
            }

            selectYear(year) {
                this.currentYear = year;
                this.renderYearButtons();
                this.renderTradesBarChart(true);
                this.renderStats();
                this.renderTradesTable();
                document.getElementById('currentYear').textContent = year;
            }

            async renderCompoundHistoryCharts(recreate = false) {
                const coinsAll = this.coinList.length ? this.coinList : ['btc','eth','sol'];
                const coins = ['btc','eth','sol'].filter(c => coinsAll.includes(c));
                for (const c of coins) {
                    await this.renderCompoundHistoryForCoin(c, recreate);
                }
            }

            async renderCompoundHistoryForCoin(c, recreate = false) {
                const idMap = { btc: 'compoundHistoryBTC', eth: 'compoundHistoryETH', sol: 'compoundHistorySOL' };
                const canvasId = idMap[c];
                const el = document.getElementById(canvasId);
                if (!el) return;
                const resp = await fetch(`converted-data/${c}-trades.json`);
                if (!resp.ok) return;
                const data = await resp.json();
                const years = (data.summary && data.summary.years) ? data.summary.years : Object.keys(data.yearlyData || {}).sort();
                const labels = [];
                const barData = [];
                const lineData = [];
                let equity = 10000.0;
                for (const y of years) {
                    const trades = (data.yearlyData && data.yearlyData[y] && data.yearlyData[y].trades) ? data.yearlyData[y].trades : [];
                    for (const t of trades) {
                        const rate = Number(t.pnlPercent) / 100.0;
                        const before = equity;
                        const comp = Math.round(before * rate * 100) / 100;
                        equity = Math.round((before + comp) * 100) / 100;
                        labels.push(`#${t.tradeNum}`);
                        barData.push(comp);
                        lineData.push(equity);
                    }
                }
                const ctx = el.getContext('2d');
                const key = `compoundHistory_${c}`;
                if (recreate && this.charts[key]) {
                    this.charts[key].destroy();
                }
                const colorBar = c === 'btc' ? 'rgba(255, 159, 64, 0.6)' : (c === 'eth' ? 'rgba(153, 102, 255, 0.6)' : 'rgba(75, 192, 192, 0.6)');
                const colorBarBorder = c === 'btc' ? 'rgba(255, 159, 64, 1)' : (c === 'eth' ? 'rgba(153, 102, 255, 1)' : 'rgba(75, 192, 192, 1)');
                const colorLine = 'rgba(40, 167, 69, 1)';
                const colorLineBg = 'rgba(40, 167, 69, 0.25)';
                this.charts[key] = new Chart(ctx, {
                    data: {
                        labels,
                        datasets: [
                            {
                                type: 'bar',
                                label: '每笔复利收益',
                                data: barData,
                                backgroundColor: colorBar,
                                borderColor: colorBarBorder,
                                borderWidth: 1,
                                yAxisID: 'y'
                            },
                            {
                                type: 'line',
                                label: '累计权益',
                                data: lineData,
                                borderColor: colorLine,
                                backgroundColor: colorLineBg,
                                tension: 0.2,
                                yAxisID: 'y2'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: true },
                            tooltip: {
                                callbacks: {
                                    label: (ctx) => {
                                        if (ctx.dataset.type === 'bar') {
                                            const v = ctx.parsed.y || 0;
                                            const sign = v >= 0 ? '+' : '';
                                            return `${sign}¥${v.toLocaleString()}`;
                                        } else {
                                            const v = ctx.parsed.y || 0;
                                            return `权益 ¥${v.toLocaleString()}`;
                                        }
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                position: 'left',
                                ticks: { callback: (v) => '¥' + v.toLocaleString() },
                                title: { display: true, text: '复利收益' }
                            },
                            y2: {
                                position: 'right',
                                grid: { drawOnChartArea: false },
                                ticks: { callback: (v) => '¥' + v.toLocaleString() },
                                title: { display: true, text: '累计权益' }
                            }
                        }
                    }
                });
            }

            async renderCompoundSummaryChart(recreate = false) {
                const coinsAll = this.coinList.length ? this.coinList : ['btc','eth','sol'];
                const coins = ['btc','eth','sol'].filter(c => coinsAll.includes(c));
                const labels = coins.map(c => c.toUpperCase());
                const initialEquity = 10000.0;
                const compPnls = [];
                const finalEquities = [];
                for (const c of coins) {
                    const resp = await fetch(`converted-data/${c}-trades.json`);
                    if (!resp.ok) continue;
                    const data = await resp.json();
                    let equity = initialEquity;
                    const years = (data.summary && data.summary.years) ? data.summary.years : Object.keys(data.yearlyData || {}).sort();
                    for (const y of years) {
                        const trades = (data.yearlyData && data.yearlyData[y] && data.yearlyData[y].trades) ? data.yearlyData[y].trades : [];
                        for (const t of trades) {
                            const rate = Number(t.pnlPercent) / 100.0;
                            const comp = equity * rate;
                            equity = Math.round((equity + comp) * 100) / 100;
                        }
                    }
                    finalEquities.push(equity);
                    compPnls.push(Math.round((equity - initialEquity) * 100) / 100);
                }
                const ctx = document.getElementById('compoundSummaryChart').getContext('2d');
                if (recreate && this.charts.compoundSummary) {
                    this.charts.compoundSummary.destroy();
                }
                this.charts.compoundSummary = new Chart(ctx, {
                    data: {
                        labels,
                        datasets: [
                            {
                                type: 'bar',
                                label: '复利累计收益',
                                data: compPnls,
                                backgroundColor: 'rgba(102, 126, 234, 0.6)',
                                borderColor: 'rgba(102, 126, 234, 1)',
                                borderWidth: 1,
                                yAxisID: 'y'
                            },
                            {
                                type: 'line',
                                label: '最终权益',
                                data: finalEquities,
                                borderColor: 'rgba(40, 167, 69, 1)',
                                backgroundColor: 'rgba(40, 167, 69, 0.25)',
                                tension: 0.3,
                                yAxisID: 'y2'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: true }
                        },
                        scales: {
                            y: {
                                position: 'left',
                                ticks: { callback: (v) => '¥' + v.toLocaleString() },
                                title: { display: true, text: '复利收益' }
                            },
                            y2: {
                                position: 'right',
                                grid: { drawOnChartArea: false },
                                ticks: { callback: (v) => '¥' + v.toLocaleString() },
                                title: { display: true, text: '最终权益' }
                            }
                        }
                    }
                });
            }
            
            renderTradesBarChart(recreate = false) {
                const ctx = document.getElementById('tradesBarChart').getContext('2d');
                const yearData = this.data.yearlyData[this.currentYear];
                const trades = yearData ? yearData.trades : [];
                const labels = trades.map(t => `#${t.tradeNum}`);
                const values = trades.map(t => t.pnl);
                const colors = trades.map(t => t.pnl >= 0 ? 'rgba(40, 167, 69, 0.85)' : 'rgba(220, 53, 69, 0.85)');
                const borders = trades.map(t => t.pnl >= 0 ? 'rgba(40, 167, 69, 1)' : 'rgba(220, 53, 69, 1)');

                if (recreate && this.charts.tradesBar) {
                    this.charts.tradesBar.destroy();
                }

                this.charts.tradesBar = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels,
                        datasets: [{
                            label: '盈亏',
                            data: values,
                            backgroundColor: colors,
                            borderColor: borders,
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: (ctx) => {
                                        const i = ctx.dataIndex;
                                        const t = trades[i];
                                        const sign = t.pnl >= 0 ? '+' : '';
                                        return `${sign}¥${t.pnl.toLocaleString()} (${t.pnlPercent.toFixed(2)}%)`;
                                    },
                                    title: (items) => {
                                        const i = items[0].dataIndex;
                                        const t = trades[i];
                                        return `#${t.tradeNum} ${t.entryDate} → ${t.exitDate}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                ticks: {
                                    callback: (v) => '¥' + v.toLocaleString()
                                }
                            }
                        }
                    }
                });
            }
            
            renderTradesTable() {
                const yearData = this.data.yearlyData[this.currentYear];
                if (!yearData) return;
                
                const tbody = document.getElementById('tradesTableBody');
                tbody.innerHTML = yearData.trades.map(trade => `
                    <tr>
                        <td>#${trade.tradeNum}</td>
                        <td>
                            <span class="${trade.position === 'long' ? 'positive' : 'negative'}">
                                ${trade.position === 'long' ? '多单' : '空单'}
                            </span>
                        </td>
                        <td>${trade.entryDate}</td>
                        <td>$${trade.entryPrice.toLocaleString()}</td>
                        <td>${trade.exitDate}</td>
                        <td>$${trade.exitPrice.toLocaleString()}</td>
                        <td class="${trade.pnl >= 0 ? 'positive' : 'negative'}">
                            ${trade.pnl >= 0 ? '+' : ''}¥${trade.pnl.toLocaleString()}
                        </td>
                        <td class="${trade.pnlPercent >= 0 ? 'positive' : 'negative'}">
                            ${trade.pnlPercent >= 0 ? '+' : ''}${trade.pnlPercent.toFixed(2)}%
                        </td>
                    </tr>
                `).join('');
            }
            
            showContent() {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('content').style.display = 'block';
            }
            
            showError(message) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').textContent = message;
            }
        }
        
        // 初始化分析器
        const analyzer = new TradingDataAnalyzer();
    </script>
</body>
</html>
